# Docker Deployment Configuration\n\nThis guide covers deploying ClaudeCluster using Docker and Docker Compose.\n\n## Required Configuration\n\n### Docker Compose Setup\n\n**docker-compose.yml:**\n```yaml\nversion: '3.8'\n\nservices:\n  mcp-server:\n    build:\n      context: .\n      dockerfile: packages/mcp/Dockerfile\n    ports:\n      - \"3000:3000\"\n    environment:\n      - NODE_ENV=production\n      - CLAUDECLUSTER_MCP_SERVER_HOST=0.0.0.0\n      - CLAUDECLUSTER_MCP_SERVER_PORT=3000\n      - CLAUDECLUSTER_MCP_WORKERS_ENDPOINTS=[\"http://worker-1:3001\",\"http://worker-2:3001\"]\n      - CLAUDECLUSTER_MCP_LOGGING_LEVEL=info\n      - CLAUDECLUSTER_MCP_LOGGING_FORMAT=json\n    depends_on:\n      - worker-1\n      - worker-2\n    networks:\n      - claudecluster\n    volumes:\n      - ./data/mcp:/app/data\n      - ./logs/mcp:/app/logs\n\n  worker-1:\n    build:\n      context: .\n      dockerfile: packages/worker/Dockerfile\n    environment:\n      - NODE_ENV=production\n      - CLAUDECLUSTER_WORKER_SERVER_HOST=0.0.0.0\n      - CLAUDECLUSTER_WORKER_SERVER_PORT=3001\n      - CLAUDECLUSTER_WORKER_WORKER_ID=worker-1\n      - CLAUDECLUSTER_WORKER_WORKER_CAPABILITIES_MAXCONCURRENTTASKS=2\n      - CLAUDECLUSTER_WORKER_LOGGING_LEVEL=info\n      - CLAUDECLUSTER_WORKER_LOGGING_FORMAT=json\n    networks:\n      - claudecluster\n    volumes:\n      - ./data/worker-1:/app/data\n      - ./logs/worker-1:/app/logs\n\n  worker-2:\n    build:\n      context: .\n      dockerfile: packages/worker/Dockerfile\n    environment:\n      - NODE_ENV=production\n      - CLAUDECLUSTER_WORKER_SERVER_HOST=0.0.0.0\n      - CLAUDECLUSTER_WORKER_SERVER_PORT=3001\n      - CLAUDECLUSTER_WORKER_WORKER_ID=worker-2\n      - CLAUDECLUSTER_WORKER_WORKER_CAPABILITIES_MAXCONCURRENTTASKS=2\n      - CLAUDECLUSTER_WORKER_LOGGING_LEVEL=info\n      - CLAUDECLUSTER_WORKER_LOGGING_FORMAT=json\n    networks:\n      - claudecluster\n    volumes:\n      - ./data/worker-2:/app/data\n      - ./logs/worker-2:/app/logs\n\n  # Optional: CLI container for job submission\n  cli:\n    build:\n      context: .\n      dockerfile: packages/cli/Dockerfile\n    environment:\n      - CLAUDECLUSTER_CLI_SERVER_URL=http://mcp-server:3000\n      - CLAUDECLUSTER_CLI_SERVER_TIMEOUT=60000\n      - CLAUDECLUSTER_CLI_LOGGING_LEVEL=info\n    networks:\n      - claudecluster\n    volumes:\n      - ./data/cli:/app/data\n    profiles:\n      - tools\n\nnetworks:\n  claudecluster:\n    driver: bridge\n\nvolumes:\n  mcp-data:\n  worker-1-data:\n  worker-2-data:\n  cli-data:\n```\n\n### Environment File\n\n**.env (for docker-compose):**\n```bash\n# Composition settings\nCOMPOSE_PROJECT_NAME=claudecluster\n\n# MCP Server\nCLAUDECLUSTER_MCP_SERVER_HOST=0.0.0.0\nCLAUDECLUSTER_MCP_SERVER_PORT=3000\nCLAUDECLUSTER_MCP_WORKERS_ENDPOINTS=[\"http://worker-1:3001\",\"http://worker-2:3001\"]\nCLAUDECLUSTER_MCP_LOGGING_LEVEL=info\nCLAUDECLUSTER_MCP_LOGGING_FORMAT=json\n\n# Workers\nCLAUDECLUSTER_WORKER_LOGGING_LEVEL=info\nCLAUDECLUSTER_WORKER_LOGGING_FORMAT=json\n\n# CLI\nCLAUDECLUSTER_CLI_SERVER_URL=http://mcp-server:3000\nCLAUDECLUSTER_CLI_LOGGING_LEVEL=info\n\n# Production settings\nNODE_ENV=production\n\n# Optional: Resource limits (Docker)\nMCP_MEMORY_LIMIT=512m\nMCP_CPU_LIMIT=0.5\nWORKER_MEMORY_LIMIT=256m\nWORKER_CPU_LIMIT=0.25\n```\n\n### Dockerfiles\n\n**packages/mcp/Dockerfile:**\n```dockerfile\nFROM node:18-alpine\n\nWORKDIR /app\n\n# Copy package files\nCOPY package*.json ./\nCOPY packages/mcp/package*.json ./packages/mcp/\nCOPY packages/shared/package*.json ./packages/shared/\n\n# Install dependencies\nRUN npm ci --only=production\n\n# Copy source code\nCOPY packages/mcp ./packages/mcp\nCOPY packages/shared ./packages/shared\n\n# Build\nRUN npm run build --workspace=packages/shared\nRUN npm run build --workspace=packages/mcp\n\n# Create data directories\nRUN mkdir -p /app/data /app/logs\n\n# Health check\nHEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=3 \\\n  CMD curl -f http://localhost:3000/health || exit 1\n\nEXPOSE 3000\n\nUSER node\n\nCMD [\"node\", \"packages/mcp/dist/main.js\"]\n```\n\n**packages/worker/Dockerfile:**\n```dockerfile\nFROM node:18-alpine\n\nWORKDIR /app\n\n# Install system dependencies for worker capabilities\nRUN apk add --no-cache git curl\n\n# Copy package files\nCOPY package*.json ./\nCOPY packages/worker/package*.json ./packages/worker/\nCOPY packages/shared/package*.json ./packages/shared/\n\n# Install dependencies\nRUN npm ci --only=production\n\n# Copy source code\nCOPY packages/worker ./packages/worker\nCOPY packages/shared ./packages/shared\n\n# Build\nRUN npm run build --workspace=packages/shared\nRUN npm run build --workspace=packages/worker\n\n# Create data directories\nRUN mkdir -p /app/data /app/logs\n\n# Health check\nHEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=3 \\\n  CMD curl -f http://localhost:3001/health || exit 1\n\nEXPOSE 3001\n\nUSER node\n\nCMD [\"node\", \"packages/worker/dist/main.js\"]\n```\n\n## Directory Structure\n\n```\nmy-project/\n├── docker-compose.yml\n├── .env\n├── .dockerignore\n├── data/                         # Persistent data\n│   ├── mcp/\n│   ├── worker-1/\n│   ├── worker-2/\n│   └── cli/\n├── logs/                         # Log files\n│   ├── mcp/\n│   ├── worker-1/\n│   └── worker-2/\n└── packages/\n    ├── mcp/\n    │   └── Dockerfile\n    ├── worker/\n    │   └── Dockerfile\n    └── cli/\n        └── Dockerfile\n```\n\n## Deployment Commands\n\n### Initial Setup\n\n```bash\n# Create required directories\nmkdir -p data/{mcp,worker-1,worker-2,cli}\nmkdir -p logs/{mcp,worker-1,worker-2}\n\n# Set permissions\nchown -R $USER:$USER data logs\n\n# Build images\ndocker-compose build\n```\n\n### Start Services\n\n```bash\n# Start core services\ndocker-compose up -d\n\n# Start with CLI tools\ndocker-compose --profile tools up -d\n\n# View logs\ndocker-compose logs -f\n\n# Check status\ndocker-compose ps\n```\n\n### Management Commands\n\n```bash\n# Scale workers\ndocker-compose up -d --scale worker-1=2\n\n# Update configuration\ndocker-compose down\ndocker-compose up -d\n\n# View logs\ndocker-compose logs mcp-server\ndocker-compose logs worker-1\n\n# Execute commands\ndocker-compose exec mcp-server sh\n```\n\n### Using the CLI\n\n```bash\n# Run CLI commands\ndocker-compose run --rm cli status\ndocker-compose run --rm cli run \"Create a hello world script\"\n\n# Interactive CLI session\ndocker-compose run --rm cli sh\n```\n\n## Configuration Override\n\n### Environment-Specific Configuration\n\n**docker-compose.override.yml (development):**\n```yaml\nversion: '3.8'\n\nservices:\n  mcp-server:\n    environment:\n      - CLAUDECLUSTER_MCP_LOGGING_LEVEL=debug\n    volumes:\n      - ./packages/mcp/src:/app/packages/mcp/src:ro\n  \n  worker-1:\n    environment:\n      - CLAUDECLUSTER_WORKER_LOGGING_LEVEL=debug\n    volumes:\n      - ./packages/worker/src:/app/packages/worker/src:ro\n```\n\n**docker-compose.prod.yml (production):**\n```yaml\nversion: '3.8'\n\nservices:\n  mcp-server:\n    deploy:\n      resources:\n        limits:\n          memory: 512M\n          cpus: '0.5'\n        reservations:\n          memory: 256M\n          cpus: '0.25'\n    environment:\n      - CLAUDECLUSTER_MCP_LOGGING_LEVEL=warn\n      - CLAUDECLUSTER_MCP_LOGGING_FORMAT=json\n  \n  worker-1:\n    deploy:\n      resources:\n        limits:\n          memory: 256M\n          cpus: '0.25'\n        reservations:\n          memory: 128M\n          cpus: '0.125'\n    environment:\n      - CLAUDECLUSTER_WORKER_LOGGING_LEVEL=warn\n      - CLAUDECLUSTER_WORKER_LOGGING_FORMAT=json\n```\n\n### Usage:\n\n```bash\n# Development\ndocker-compose -f docker-compose.yml -f docker-compose.override.yml up -d\n\n# Production\ndocker-compose -f docker-compose.yml -f docker-compose.prod.yml up -d\n```\n\n## Monitoring and Logging\n\n### Health Checks\n\n```bash\n# Check service health\ndocker-compose ps\n\n# View health check logs\ndocker inspect claudecluster_mcp-server_1 --format='{{.State.Health}}'\n```\n\n### Log Management\n\n```bash\n# Follow all logs\ndocker-compose logs -f\n\n# Service-specific logs\ndocker-compose logs -f mcp-server\n\n# Log rotation (add to docker-compose.yml)\nlogging:\n  driver: \"json-file\"\n  options:\n    max-size: \"10m\"\n    max-file: \"3\"\n```\n\n## Security Configuration\n\n### Network Isolation\n\n```yaml\n# Internal network for components\nnetworks:\n  claudecluster-internal:\n    driver: bridge\n    internal: true\n  claudecluster-external:\n    driver: bridge\n\nservices:\n  mcp-server:\n    networks:\n      - claudecluster-external  # Exposed to outside\n      - claudecluster-internal  # Worker communication\n  \n  worker-1:\n    networks:\n      - claudecluster-internal  # Internal only\n```\n\n### Secrets Management\n\n```yaml\nsecrets:\n  api_key:\n    file: ./secrets/api_key.txt\n\nservices:\n  mcp-server:\n    secrets:\n      - api_key\n    environment:\n      - CLAUDECLUSTER_API_KEY_FILE=/run/secrets/api_key\n```\n\n## Performance Tuning\n\n### Resource Limits\n\n```yaml\nservices:\n  mcp-server:\n    deploy:\n      resources:\n        limits:\n          memory: 1G\n          cpus: '1.0'\n    ulimits:\n      nofile:\n        soft: 65536\n        hard: 65536\n```\n\n### Volume Performance\n\n```yaml\nvolumes:\n  mcp-data:\n    driver_opts:\n      type: tmpfs\n      device: tmpfs\n      o: size=100m,uid=1000,gid=1000\n```\n\n## Troubleshooting\n\n### Common Issues\n\n1. **Service won't start:**\n   ```bash\n   docker-compose logs [service-name]\n   docker-compose exec [service-name] sh\n   ```\n\n2. **Network connectivity:**\n   ```bash\n   docker-compose exec mcp-server ping worker-1\n   docker network ls\n   docker network inspect claudecluster_claudecluster\n   ```\n\n3. **Configuration issues:**\n   ```bash\n   docker-compose config  # Validate compose file\n   docker-compose exec mcp-server env | grep CLAUDECLUSTER\n   ```\n\n### Debug Mode\n\n```bash\n# Enable debug logging\necho \"CLAUDECLUSTER_MCP_LOGGING_LEVEL=debug\" >> .env\necho \"CLAUDECLUSTER_WORKER_LOGGING_LEVEL=debug\" >> .env\n\n# Restart with new config\ndocker-compose down\ndocker-compose up -d\n\n# View debug logs\ndocker-compose logs -f\n```\n\n## Next Steps\n\n- [Google Cloud Run Deployment](cloud-run-deployment.md)\n- [Production Setup](production.md)\n- [Monitoring and Observability](monitoring.md)"