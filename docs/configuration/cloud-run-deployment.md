# Google Cloud Run Deployment Configuration\n\nThis guide covers deploying ClaudeCluster on Google Cloud Run with proper configuration for scalability and security.\n\n## Required Configuration\n\n### Prerequisites\n\n- Google Cloud Platform account\n- `gcloud` CLI installed and authenticated\n- Docker installed locally\n- Project with billing enabled\n\n### Required Environment Variables\n\n**MCP Server:**\n```bash\n# Server configuration\nCLAUDECLUSTER_MCP_SERVER_HOST=0.0.0.0\nCLAUDECLUSTER_MCP_SERVER_PORT=8080  # Cloud Run default\n\n# Worker endpoints (Cloud Run service URLs)\nCLAUDECLUSTER_MCP_WORKERS_ENDPOINTS='[\"https://worker-1-xxx-uc.a.run.app\",\"https://worker-2-xxx-uc.a.run.app\"]'\n\n# Logging (structured for Cloud Logging)\nCLAUDECLUSTER_MCP_LOGGING_LEVEL=info\nCLAUDECLUSTER_MCP_LOGGING_FORMAT=json\n\n# Cloud-specific settings\nCLAUDECLUSTER_MCP_WORKERS_REQUESTTIMEOUTMS=60000\nCLAUDECLUSTER_MCP_WORKERS_MAXRETRIES=3\nCLAUDECLUSTER_MCP_MONITORING_TASKTIMEOUT=300000\n\n# Environment\nNODE_ENV=production\nGCLOUD_PROJECT=your-project-id\n```\n\n**Worker:**\n```bash\n# Server configuration\nCLAUDECLUSTER_WORKER_SERVER_HOST=0.0.0.0\nCLAUDECLUSTER_WORKER_SERVER_PORT=8080\n\n# Worker identification (unique per service)\nCLAUDECLUSTER_WORKER_WORKER_ID=worker-${REVISION_TAG}\n\n# Capabilities (adjust based on Cloud Run resources)\nCLAUDECLUSTER_WORKER_WORKER_CAPABILITIES_MAXCONCURRENTTASKS=2\nCLAUDECLUSTER_WORKER_WORKER_CAPABILITIES_TIMEOUT=300000\n\n# Logging\nCLAUDECLUSTER_WORKER_LOGGING_LEVEL=info\nCLAUDECLUSTER_WORKER_LOGGING_FORMAT=json\n\n# Environment\nNODE_ENV=production\n```\n\n## Deployment Configuration\n\n### Cloud Run Service Configuration\n\n**mcp-server service (cloudbuild.yaml):**\n```yaml\nsteps:\n  # Build image\n  - name: 'gcr.io/cloud-builders/docker'\n    args: [\n      'build',\n      '-t', 'gcr.io/$PROJECT_ID/mcp-server:$BUILD_ID',\n      '-f', 'packages/mcp/Dockerfile.cloudrun',\n      '.'\n    ]\n  \n  # Push image\n  - name: 'gcr.io/cloud-builders/docker'\n    args: ['push', 'gcr.io/$PROJECT_ID/mcp-server:$BUILD_ID']\n  \n  # Deploy to Cloud Run\n  - name: 'gcr.io/cloud-builders/gcloud'\n    args:\n    - 'run'\n    - 'deploy'\n    - 'mcp-server'\n    - '--image=gcr.io/$PROJECT_ID/mcp-server:$BUILD_ID'\n    - '--platform=managed'\n    - '--region=us-central1'\n    - '--allow-unauthenticated'\n    - '--port=8080'\n    - '--memory=1Gi'\n    - '--cpu=2'\n    - '--min-instances=0'\n    - '--max-instances=10'\n    - '--concurrency=80'\n    - '--timeout=300'\n    - '--set-env-vars=NODE_ENV=production,CLAUDECLUSTER_MCP_SERVER_HOST=0.0.0.0,CLAUDECLUSTER_MCP_SERVER_PORT=8080'\n    - '--service-account=claudecluster-mcp@$PROJECT_ID.iam.gserviceaccount.com'\n\nimages:\n  - 'gcr.io/$PROJECT_ID/mcp-server:$BUILD_ID'\n\noptions:\n  logging: CLOUD_LOGGING_ONLY\n```\n\n**Worker service configuration:**\n```yaml\nsteps:\n  # Build worker image\n  - name: 'gcr.io/cloud-builders/docker'\n    args: [\n      'build',\n      '-t', 'gcr.io/$PROJECT_ID/worker:$BUILD_ID',\n      '-f', 'packages/worker/Dockerfile.cloudrun',\n      '.'\n    ]\n  \n  - name: 'gcr.io/cloud-builders/docker'\n    args: ['push', 'gcr.io/$PROJECT_ID/worker:$BUILD_ID']\n  \n  # Deploy multiple worker instances\n  - name: 'gcr.io/cloud-builders/gcloud'\n    args:\n    - 'run'\n    - 'deploy'\n    - 'worker-1'\n    - '--image=gcr.io/$PROJECT_ID/worker:$BUILD_ID'\n    - '--platform=managed'\n    - '--region=us-central1'\n    - '--no-allow-unauthenticated'  # Internal only\n    - '--port=8080'\n    - '--memory=512Mi'\n    - '--cpu=1'\n    - '--min-instances=0'\n    - '--max-instances=5'\n    - '--concurrency=1'  # One task per instance\n    - '--timeout=600'\n    - '--set-env-vars=NODE_ENV=production,CLAUDECLUSTER_WORKER_WORKER_ID=worker-1'\n    - '--service-account=claudecluster-worker@$PROJECT_ID.iam.gserviceaccount.com'\n  \n  - name: 'gcr.io/cloud-builders/gcloud'\n    args:\n    - 'run'\n    - 'deploy'\n    - 'worker-2'\n    - '--image=gcr.io/$PROJECT_ID/worker:$BUILD_ID'\n    - '--platform=managed'\n    - '--region=us-central1'\n    - '--no-allow-unauthenticated'\n    - '--port=8080'\n    - '--memory=512Mi'\n    - '--cpu=1'\n    - '--min-instances=0'\n    - '--max-instances=5'\n    - '--concurrency=1'\n    - '--timeout=600'\n    - '--set-env-vars=NODE_ENV=production,CLAUDECLUSTER_WORKER_WORKER_ID=worker-2'\n    - '--service-account=claudecluster-worker@$PROJECT_ID.iam.gserviceaccount.com'\n```\n\n### Dockerfile for Cloud Run\n\n**packages/mcp/Dockerfile.cloudrun:**\n```dockerfile\nFROM node:18-slim\n\n# Install system dependencies\nRUN apt-get update && apt-get install -y \\\n    curl \\\n    && rm -rf /var/lib/apt/lists/*\n\nWORKDIR /app\n\n# Copy package files\nCOPY package*.json ./\nCOPY packages/mcp/package*.json ./packages/mcp/\nCOPY packages/shared/package*.json ./packages/shared/\n\n# Install dependencies\nRUN npm ci --only=production --audit=false\n\n# Copy and build source\nCOPY packages/shared ./packages/shared\nCOPY packages/mcp ./packages/mcp\n\nRUN npm run build --workspace=packages/shared && \\\n    npm run build --workspace=packages/mcp\n\n# Create non-root user\nRUN useradd -r -u 1001 -g root claudecluster\nUSER claudecluster\n\n# Health check\nHEALTHCHECK --interval=60s --timeout=10s --start-period=60s --retries=3 \\\n  CMD curl -f http://localhost:8080/health || exit 1\n\nEXPOSE 8080\n\n# Use exec form for proper signal handling\nCMD [\"node\", \"packages/mcp/dist/main.js\"]\n```\n\n### Service Accounts and IAM\n\n**Create service accounts:**\n```bash\n# MCP Server service account\ngcloud iam service-accounts create claudecluster-mcp \\\n  --display-name=\"ClaudeCluster MCP Server\"\n\n# Worker service account  \ngcloud iam service-accounts create claudecluster-worker \\\n  --display-name=\"ClaudeCluster Worker\"\n\n# Grant necessary permissions\ngcloud projects add-iam-policy-binding $PROJECT_ID \\\n  --member=\"serviceAccount:claudecluster-mcp@$PROJECT_ID.iam.gserviceaccount.com\" \\\n  --role=\"roles/run.invoker\"\n\ngcloud projects add-iam-policy-binding $PROJECT_ID \\\n  --member=\"serviceAccount:claudecluster-mcp@$PROJECT_ID.iam.gserviceaccount.com\" \\\n  --role=\"roles/logging.logWriter\"\n\n# Allow MCP server to invoke workers\ngcloud run services add-iam-policy-binding worker-1 \\\n  --member=\"serviceAccount:claudecluster-mcp@$PROJECT_ID.iam.gserviceaccount.com\" \\\n  --role=\"roles/run.invoker\" \\\n  --region=us-central1\n```\n\n### Secret Management\n\n**Using Google Secret Manager:**\n```bash\n# Create secrets\necho -n \"your-api-key\" | gcloud secrets create claudecluster-api-key --data-file=-\n\n# Grant access to service accounts\ngcloud secrets add-iam-policy-binding claudecluster-api-key \\\n  --member=\"serviceAccount:claudecluster-mcp@$PROJECT_ID.iam.gserviceaccount.com\" \\\n  --role=\"roles/secretmanager.secretAccessor\"\n\n# Mount secrets in Cloud Run\ngcloud run services update mcp-server \\\n  --update-secrets=\"/secrets/api-key=claudecluster-api-key:latest\" \\\n  --region=us-central1\n```\n\n## Environment-Specific Configuration\n\n### Production Configuration\n\n**claudecluster.prod.json:**\n```json\n{\n  \"server\": {\n    \"host\": \"0.0.0.0\",\n    \"port\": 8080,\n    \"cors\": {\n      \"origin\": [\"https://yourdomain.com\", \"https://cli.yourdomain.com\"],\n      \"credentials\": true\n    },\n    \"rateLimit\": {\n      \"windowMs\": 60000,\n      \"maxRequests\": 1000\n    }\n  },\n  \"workers\": {\n    \"endpoints\": [\n      \"https://worker-1-xxx-uc.a.run.app\",\n      \"https://worker-2-xxx-uc.a.run.app\"\n    ],\n    \"maxRetries\": 3,\n    \"requestTimeoutMs\": 60000,\n    \"selectionStrategy\": \"least-loaded\"\n  },\n  \"logging\": {\n    \"level\": \"info\",\n    \"console\": true,\n    \"format\": \"json\"\n  },\n  \"monitoring\": {\n    \"enabled\": true,\n    \"heartbeatInterval\": 60000,\n    \"taskTimeout\": 300000,\n    \"retryAttempts\": 3\n  }\n}\n```\n\n### Staging Configuration\n\n**claudecluster.staging.json:**\n```json\n{\n  \"server\": {\n    \"host\": \"0.0.0.0\",\n    \"port\": 8080\n  },\n  \"workers\": {\n    \"endpoints\": [\n      \"https://worker-staging-xxx-uc.a.run.app\"\n    ],\n    \"maxRetries\": 2,\n    \"requestTimeoutMs\": 30000\n  },\n  \"logging\": {\n    \"level\": \"debug\",\n    \"format\": \"json\"\n  },\n  \"monitoring\": {\n    \"heartbeatInterval\": 30000,\n    \"taskTimeout\": 180000\n  }\n}\n```\n\n## Deployment Scripts\n\n### Setup Script\n\n**scripts/deploy-cloudrun.sh:**\n```bash\n#!/bin/bash\n\nset -e\n\nPROJECT_ID=${GCLOUD_PROJECT:-\"your-project-id\"}\nREGION=${REGION:-\"us-central1\"}\nENVIRONMENT=${ENVIRONMENT:-\"production\"}\n\necho \"Deploying ClaudeCluster to Cloud Run...\"\necho \"Project: $PROJECT_ID\"\necho \"Region: $REGION\"\necho \"Environment: $ENVIRONMENT\"\n\n# Enable required APIs\ngcloud services enable run.googleapis.com\ngcloud services enable cloudbuild.googleapis.com\ngcloud services enable containerregistry.googleapis.com\ngcloud services enable secretmanager.googleapis.com\n\n# Create service accounts if they don't exist\ngcloud iam service-accounts describe claudecluster-mcp@$PROJECT_ID.iam.gserviceaccount.com 2>/dev/null || \\\ngcloud iam service-accounts create claudecluster-mcp --display-name=\"ClaudeCluster MCP Server\"\n\ngcloud iam service-accounts describe claudecluster-worker@$PROJECT_ID.iam.gserviceaccount.com 2>/dev/null || \\\ngcloud iam service-accounts create claudecluster-worker --display-name=\"ClaudeCluster Worker\"\n\n# Build and deploy\ngcloud builds submit --config=cloudbuild.yaml\n\n# Update worker endpoints in MCP server\nWORKER_1_URL=$(gcloud run services describe worker-1 --region=$REGION --format=\"value(status.url)\")\nWORKER_2_URL=$(gcloud run services describe worker-2 --region=$REGION --format=\"value(status.url)\")\n\ngcloud run services update mcp-server \\\n  --region=$REGION \\\n  --update-env-vars=\"CLAUDECLUSTER_MCP_WORKERS_ENDPOINTS=[\\\"$WORKER_1_URL\\\",\\\"$WORKER_2_URL\\\"]\"\n\necho \"Deployment completed successfully!\"\necho \"MCP Server URL: $(gcloud run services describe mcp-server --region=$REGION --format=\"value(status.url)\")\"\n```\n\n### CLI Configuration for Cloud Run\n\n**~/.claudecluster/config.json:**\n```json\n{\n  \"server\": {\n    \"url\": \"https://mcp-server-xxx-uc.a.run.app\",\n    \"timeout\": 60000\n  },\n  \"logging\": {\n    \"level\": \"info\",\n    \"format\": \"simple\"\n  },\n  \"defaults\": {\n    \"priority\": 5,\n    \"timeout\": 600\n  }\n}\n```\n\n## Monitoring and Observability\n\n### Cloud Monitoring Metrics\n\n```bash\n# Create custom metrics\ngcloud logging metrics create claudecluster_task_duration \\\n  --description=\"Task execution duration\" \\\n  --log-filter='resource.type=\"cloud_run_revision\" AND jsonPayload.taskCompleted=true' \\\n  --value-extractor='jsonPayload.duration'\n\ngcloud logging metrics create claudecluster_task_errors \\\n  --description=\"Task execution errors\" \\\n  --log-filter='resource.type=\"cloud_run_revision\" AND jsonPayload.taskFailed=true'\n```\n\n### Alerting Policies\n\n```bash\n# Create alerting policy for high error rate\ngcloud alpha monitoring policies create \\\n  --policy-from-file=monitoring/error-rate-policy.yaml\n```\n\n**monitoring/error-rate-policy.yaml:**\n```yaml\ndisplayName: \"ClaudeCluster High Error Rate\"\ncombiner: OR\nconditions:\n- displayName: \"Error rate > 5%\"\n  conditionThreshold:\n    filter: 'resource.type=\"cloud_run_revision\" AND resource.labels.service_name=~\"mcp-server|worker-.*\"'\n    comparison: COMPARISON_GREATER_THAN\n    thresholdValue: 0.05\n    duration: 300s\nnotificationChannels: [\"projects/your-project/notificationChannels/your-channel\"]\n```\n\n## Performance Optimization\n\n### Resource Configuration\n\n```bash\n# Optimize for CPU-intensive tasks\ngcloud run services update worker-1 \\\n  --cpu=2 \\\n  --memory=1Gi \\\n  --concurrency=1 \\\n  --max-instances=10\n\n# Optimize for I/O-intensive tasks\ngcloud run services update mcp-server \\\n  --cpu=1 \\\n  --memory=512Mi \\\n  --concurrency=100 \\\n  --max-instances=5\n```\n\n### Cold Start Optimization\n\n```bash\n# Keep minimum instances warm\ngcloud run services update mcp-server \\\n  --min-instances=1\n\ngcloud run services update worker-1 \\\n  --min-instances=1\n```\n\n## Security Configuration\n\n### VPC Connector (Optional)\n\n```bash\n# Create VPC connector for internal communication\ngcloud compute networks vpc-access connectors create claudecluster-connector \\\n  --network=default \\\n  --region=us-central1 \\\n  --range=10.8.0.0/28\n\n# Configure services to use VPC connector\ngcloud run services update mcp-server \\\n  --vpc-connector=claudecluster-connector\n```\n\n### Binary Authorization (Optional)\n\n```bash\n# Enable binary authorization\ngcloud container binauthz policy import policy.yaml\n\n# Configure Cloud Run to require attestation\ngcloud run services update mcp-server \\\n  --binary-authorization=require-attestation\n```\n\n## Troubleshooting\n\n### Common Issues\n\n1. **Cold starts causing timeouts:**\n   ```bash\n   # Increase timeout and add min instances\n   gcloud run services update mcp-server \\\n     --timeout=300 \\\n     --min-instances=1\n   ```\n\n2. **Worker communication failures:**\n   ```bash\n   # Check service URLs\n   gcloud run services list --filter=\"metadata.name~worker\"\n   \n   # Verify IAM permissions\n   gcloud run services get-iam-policy worker-1 --region=us-central1\n   ```\n\n3. **Memory/CPU limits:**\n   ```bash\n   # View metrics\n   gcloud logging read 'resource.type=\"cloud_run_revision\" AND textPayload:\"memory\"' \\\n     --limit=50 --format=\"table(timestamp,textPayload)\"\n   ```\n\n### Debugging Commands\n\n```bash\n# View logs\ngcloud logs read --filter='resource.type=\"cloud_run_revision\"' --limit=50\n\n# Stream logs\ngcloud logs tail --filter='resource.type=\"cloud_run_revision\"'\n\n# Check service status\ngcloud run services describe mcp-server --region=us-central1\n\n# Test health endpoints\ncurl https://mcp-server-xxx-uc.a.run.app/health\n```\n\n## Cost Optimization\n\n### Request-Based Pricing\n\n```bash\n# Configure for cost efficiency\ngcloud run services update mcp-server \\\n  --cpu-throttling \\\n  --min-instances=0 \\\n  --max-instances=3\n\ngcloud run services update worker-1 \\\n  --cpu-throttling \\\n  --min-instances=0 \\\n  --max-instances=5\n```\n\n### Resource Right-Sizing\n\n- Monitor actual resource usage in Cloud Monitoring\n- Adjust CPU and memory allocations based on usage patterns\n- Use appropriate concurrency settings\n- Set reasonable timeout values\n\n## Next Steps\n\n- [Production Setup](production.md)\n- [Monitoring and Observability](monitoring.md)\n- [Security Best Practices](security.md)"