# ClaudeCluster Configuration Security Guide\n\nThis guide covers security best practices for managing configuration and sensitive values in ClaudeCluster.\n\n## Security Principles\n\n### 1. Never Store Secrets in Configuration Files\n\n❌ **DON'T DO THIS:**\n```json\n{\n  \"apiKey\": \"sk-1234567890abcdef\",\n  \"databaseUrl\": \"postgresql://user:password@localhost:5432/db\"\n}\n```\n\n✅ **DO THIS INSTEAD:**\n```json\n{\n  \"server\": {\n    \"url\": \"https://api.example.com\"\n  },\n  \"_note\": \"Sensitive values are loaded from environment variables\"\n}\n```\n\n### 2. Use Environment Variables for Development\n\n```bash\n# .env file (local development only)\nCLAUDECLUSTER_API_KEY=sk-1234567890abcdef\nCLAUDECLUSTER_DATABASE_URL=postgresql://user:password@localhost:5432/db\n```\n\n### 3. Use Secret Management in Production\n\n- **Google Cloud:** Google Secret Manager\n- **AWS:** AWS Secrets Manager / Systems Manager\n- **Azure:** Azure Key Vault\n- **Kubernetes:** Kubernetes Secrets\n- **Docker:** Docker Secrets\n\n## Sensitive Value Detection\n\nClaudeCluster automatically detects and masks sensitive configuration keys:\n\n### Automatically Protected Keys\n\n- `apiKey`, `api_key`\n- `secret`, `password`, `pwd`\n- `token`, `auth`, `credential`\n- `cert`, `certificate`, `private`, `key`\n- `serviceAccount`, `service_account`\n- `connectionString`, `connection_string`\n- `databaseUrl`, `database_url`\n- `oauth`, `bearer`, `authorization`\n- `clientSecret`, `client_secret`\n\n### Protected Configuration Paths\n\n- `auth.apiKey`\n- `auth.clientSecret`\n- `database.password`\n- `database.connectionString`\n- `server.tlsKey`\n- `workers.authToken`\n- And more...\n\n## Secure Configuration Patterns\n\n### Environment Variables\n\n```bash\n# Component-specific variables\nCLAUDECLUSTER_CLI_SERVER_URL=https://api.example.com\nCLAUDECLUSTER_MCP_API_KEY=your-secret-key\nCLAUDECLUSTER_WORKER_AUTH_TOKEN=worker-token\n\n# Nested configuration using dot notation\nCLAUDECLUSTER_MCP_DATABASE_HOST=localhost\nCLAUDECLUSTER_MCP_DATABASE_PASSWORD=secure-password\n```\n\n### File-Based Secrets\n\nUse `file://` URLs to load secrets from mounted files:\n\n```json\n{\n  \"database\": {\n    \"password\": \"file:///run/secrets/db-password\",\n    \"apiKey\": \"file:///var/secrets/api-key\"\n  }\n}\n```\n\n### Secret Managers\n\n**Google Secret Manager:**\n```bash\n# Store secret\necho -n \"my-secret-value\" | gcloud secrets create claudecluster-api-key --data-file=-\n\n# Mount in Cloud Run\ngcloud run services update mcp-server \\\n  --update-secrets=\"/secrets/api-key=claudecluster-api-key:latest\"\n\n# Use in configuration\n{\n  \"auth\": {\n    \"apiKey\": \"file:///secrets/api-key\"\n  }\n}\n```\n\n## Security by Environment\n\n### Local Development\n\n1. **Use .env files:**\n   ```bash\n   # .env (add to .gitignore!)\n   CLAUDECLUSTER_CLI_SERVER_URL=http://localhost:3000\n   CLAUDECLUSTER_API_KEY=dev-key-12345\n   ```\n\n2. **Separate development secrets:**\n   ```bash\n   # Use different secrets for dev vs prod\n   CLAUDECLUSTER_ENV=development\n   CLAUDECLUSTER_API_KEY=dev-test-key-not-real\n   ```\n\n3. **Use dummy values for testing:**\n   ```json\n   {\n     \"database\": {\n       \"host\": \"localhost\",\n       \"port\": 5432,\n       \"name\": \"claudecluster_dev\"\n     }\n   }\n   ```\n\n### Docker Deployment\n\n1. **Use Docker secrets:**\n   ```yaml\n   # docker-compose.yml\n   secrets:\n     api_key:\n       file: ./secrets/api_key.txt\n     db_password:\n       file: ./secrets/db_password.txt\n   \n   services:\n     mcp-server:\n       secrets:\n         - api_key\n         - db_password\n       environment:\n         - CLAUDECLUSTER_API_KEY_FILE=/run/secrets/api_key\n         - CLAUDECLUSTER_DB_PASSWORD_FILE=/run/secrets/db_password\n   ```\n\n2. **Mount secrets as files:**\n   ```dockerfile\n   # Don't expose secrets in environment variables\n   # Use file mounts instead\n   COPY --from=secrets /secrets /run/secrets\n   RUN chmod 600 /run/secrets/*\n   ```\n\n### Cloud Run Deployment\n\n1. **Google Secret Manager integration:**\n   ```bash\n   # Deploy with secret mounts\n   gcloud run deploy mcp-server \\\n     --image gcr.io/project/mcp-server \\\n     --update-secrets=\"/secrets/api-key=claudecluster-api-key:latest\" \\\n     --update-secrets=\"/secrets/db-password=claudecluster-db-password:latest\"\n   ```\n\n2. **Service account permissions:**\n   ```bash\n   # Grant minimal permissions\n   gcloud projects add-iam-policy-binding PROJECT_ID \\\n     --member=\"serviceAccount:mcp-server@PROJECT_ID.iam.gserviceaccount.com\" \\\n     --role=\"roles/secretmanager.secretAccessor\"\n   ```\n\n### Kubernetes Deployment\n\n1. **Use Kubernetes secrets:**\n   ```yaml\n   apiVersion: v1\n   kind: Secret\n   metadata:\n     name: claudecluster-secrets\n   type: Opaque\n   data:\n     api-key: <base64-encoded-value>\n     db-password: <base64-encoded-value>\n   ```\n\n2. **Mount secrets in pods:**\n   ```yaml\n   spec:\n     containers:\n     - name: mcp-server\n       volumeMounts:\n       - name: secrets\n         mountPath: /var/secrets\n         readOnly: true\n     volumes:\n     - name: secrets\n       secret:\n         secretName: claudecluster-secrets\n   ```\n\n## Logging and Monitoring Security\n\n### Automatic Log Masking\n\nClaudeCluster automatically masks sensitive values in logs:\n\n```typescript\n// Original configuration\nconst config = {\n  apiKey: 'sk-1234567890abcdef',\n  server: { url: 'https://api.example.com' }\n};\n\n// Automatically masked in logs\nlogger.info('Configuration loaded:', createSafeConfigForLogging(config));\n// Output: { apiKey: 'sk***ef', server: { url: 'https://api.example.com' } }\n```\n\n### Security Audit Warnings\n\nThe system automatically warns about potential security issues:\n\n- Placeholder values in production\n- Real secrets detected in configuration files\n- HTTP URLs for sensitive endpoints\n- Weak or default passwords\n\n## Security Validation\n\n### Automatic Security Checks\n\n```bash\n# The CLI automatically performs security validation\nclaudecluster status --verbose\n\n# Example warnings:\n# Warning: Environment variable API_KEY appears to contain a placeholder value\n# Warning: Configuration file contains potential exposed secret at \"auth.apiKey\"\n```\n\n### Manual Security Audit\n\n```typescript\nimport { auditEnvironmentVariables, validateConfigSecurity } from '@claudecluster/shared';\n\n// Audit environment variables\nconst { warnings, recommendations } = auditEnvironmentVariables();\nconsole.log('Security warnings:', warnings);\nconsole.log('Recommendations:', recommendations);\n\n// Validate configuration\nconst config = loadConfiguration();\nconst securityIssues = validateConfigSecurity(config, 'config-file');\n```\n\n## Best Practices Checklist\n\n### Development\n\n- [ ] Use `.env` files for local secrets\n- [ ] Add `.env` to `.gitignore`\n- [ ] Use different secrets for dev/staging/prod\n- [ ] Never commit real secrets to version control\n- [ ] Use placeholder values in example configurations\n\n### Production\n\n- [ ] Use dedicated secret management service\n- [ ] Mount secrets as files, not environment variables\n- [ ] Implement secret rotation policies\n- [ ] Use service accounts with minimal permissions\n- [ ] Enable audit logging for secret access\n- [ ] Use encrypted communication (TLS/HTTPS)\n- [ ] Regular security reviews of configurations\n\n### Monitoring\n\n- [ ] Monitor for exposed secrets in logs\n- [ ] Alert on configuration validation failures\n- [ ] Track secret access and usage\n- [ ] Monitor for unauthorized configuration changes\n\n## Common Security Mistakes\n\n### ❌ Committing Secrets to Git\n\n```bash\n# This will expose your secrets!\ngit add .env\ngit commit -m \"Add configuration\"\n```\n\n**Prevention:**\n```bash\n# Add to .gitignore\necho \".env\" >> .gitignore\necho \"*.secret\" >> .gitignore\necho \"secrets/\" >> .gitignore\n```\n\n### ❌ Passing Secrets as Build Arguments\n\n```dockerfile\n# DON'T DO THIS - secrets will be in Docker history\nARG API_KEY\nENV CLAUDECLUSTER_API_KEY=${API_KEY}\n```\n\n**Solution:**\n```dockerfile\n# Use multi-stage build or runtime secret mounting\nCOPY --from=secrets /run/secrets/api-key /run/secrets/api-key\n```\n\n### ❌ Logging Sensitive Configuration\n\n```typescript\n// DON'T DO THIS - will expose secrets in logs\nconsole.log('Config:', JSON.stringify(config));\n\n// DO THIS - use safe logging\nconsole.log('Config:', createSafeConfigForLogging(config));\n```\n\n### ❌ Using Weak or Default Values\n\n```bash\n# Avoid these in production\nCLAUDECLUSTER_API_KEY=your-api-key-here\nCLAUDECLUSTER_PASSWORD=password123\nCLAUDECLUSTER_SECRET=secret\n```\n\n## Security Tools and Resources\n\n### Git Hooks for Secret Detection\n\n```bash\n# Install git-secrets\nbrew install git-secrets\n\n# Configure for your repo\ngit secrets --install\ngit secrets --register-aws\n```\n\n### Secret Scanning Tools\n\n- [GitLeaks](https://github.com/zricethezav/gitleaks)\n- [TruffleHog](https://github.com/dxa4481/truffleHog)\n- [detect-secrets](https://github.com/Yelp/detect-secrets)\n\n### Environment-Specific Security\n\n- **Google Cloud:** [Secret Manager](https://cloud.google.com/secret-manager)\n- **AWS:** [Secrets Manager](https://aws.amazon.com/secrets-manager/)\n- **Azure:** [Key Vault](https://azure.microsoft.com/en-us/services/key-vault/)\n- **Kubernetes:** [Secrets](https://kubernetes.io/docs/concepts/configuration/secret/)\n\n## Incident Response\n\n### If Secrets Are Exposed\n\n1. **Immediate Actions:**\n   - Rotate the exposed secret immediately\n   - Revoke access for the compromised credential\n   - Check access logs for unauthorized usage\n\n2. **Investigation:**\n   - Determine how the secret was exposed\n   - Check git history for committed secrets\n   - Review access logs and audit trails\n\n3. **Prevention:**\n   - Implement additional security measures\n   - Update security procedures\n   - Add secret scanning to CI/CD pipeline\n\n### Emergency Contacts\n\n- Security team\n- Cloud provider support\n- Service provider (for API keys)\n- DevOps/Infrastructure team\n\n## Additional Resources\n\n- [OWASP Configuration Security](https://owasp.org/www-project-top-ten/2017/A6_2017-Security_Misconfiguration)\n- [12-Factor App Configuration](https://12factor.net/config)\n- [Google Cloud Security Best Practices](https://cloud.google.com/security/best-practices)\n- [AWS Security Best Practices](https://aws.amazon.com/architecture/security-identity-compliance/)\n\n---\n\n*Remember: Security is an ongoing process, not a one-time setup. Regularly review and update your security practices.*"